<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Management System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load Alpine.js -->
    <!-- 'defer' is crucial. It waits for the page to load before running Alpine. -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script>
        function medicalApp() {
            return {
                // --- Core App State ---
                loading: true,
                currentTab: 'dashboard', // Default tab is now dashboard
                tabs: [
                    // Added Dashboard
                    { id: 'dashboard', name: 'Dashboard', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />' },
                    { id: 'patients', name: 'Patients', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />' },
                    { id: 'doctors', name: 'Doctors', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />' },
                    { id: 'appointments', name: 'Appointments', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />' },
                    { id: 'billing', name: 'Billing', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />' },
                    { id: 'inventory', name: 'Inventory', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />' }
                ],

                // --- Data Properties ---
                patients: [],
                doctors: [],
                appointments: [],
                billing: [],
                inventory: [],

                // --- Search Properties ---
                searchPatient: '',
                searchDoctor: '',
                searchAppointment: '',
                searchBilling: '',
                searchInventory: '',

                // --- Modal & Form State ---
                modal: {
                    open: false,
                    type: '',
                    title: '',
                    isEdit: false
                },
                form: {},

                // For Billing Line Items
                billItem: { id: '', name: '', quantity: 1, price: 0 },

                // For Viewing Bill Items
                viewBillItems: [],

                // --- Schemas for clearing the form ---
                schemas: {
                    // Updated for DOB
                    patients: { id: null, name: '', contact: '', history: '', dob: '', gender: 'M' },
                    doctors: { id: null, name: '', specialty: '', schedule: '' },
                    // Updated to save patient/doctor IDs
                    appointments: { id: null, patient: '', doctor: '', datetime: new Date().toISOString().slice(0, 16) },
                    // Updated for line items
                    billing: { id: null, patient: '', items: [], total: 0, status: 'Pending' },
                    // Updated for price
                    inventory: { id: null, item: '', quantity: 0, supplier: '', price: 0.0 }
                },

                // --- Computed Properties (for Search) ---
                get filteredPatients() {
                    if (!this.searchPatient) return this.patients;
                    return this.patients.filter(p =>
                        p.name.toLowerCase().includes(this.searchPatient.toLowerCase())
                    );
                },
                get filteredDoctors() {
                    if (!this.searchDoctor) return this.doctors;
                    return this.doctors.filter(d =>
                        d.name.toLowerCase().includes(this.searchDoctor.toLowerCase()) ||
                        d.specialty.toLowerCase().includes(this.searchDoctor.toLowerCase())
                    );
                },
                get filteredAppointments() {
                    if (!this.searchAppointment) return this.appointments;
                    const search = this.searchAppointment.toLowerCase();
                    return this.appointments.filter(a =>
                        this.getPatientName(a.patient).toLowerCase().includes(search) ||
                        this.getDoctorName(a.doctor).toLowerCase().includes(search)
                    );
                },
                get filteredBilling() {
                    if (!this.searchBilling) return this.billing;
                    const search = this.searchBilling.toLowerCase();
                    return this.billing.filter(b =>
                        this.getPatientName(b.patient).toLowerCase().includes(search) ||
                        b.status.toLowerCase().includes(search)
                    );
                },
                get filteredInventory() {
                    if (!this.searchInventory) return this.inventory;
                    return this.inventory.filter(i =>
                        i.item.toLowerCase().includes(this.searchInventory.toLowerCase())
                    );
                },

                // --- Computed Properties (for Dashboard) ---
                get todaysAppointments() {
                    const today = new Date().toLocaleDateString('en-CA'); // 'YYYY-MM-DD'
                    return this.appointments.filter(a => a.datetime && a.datetime.startsWith(today));
                },
                get pendingBillCount() {
                    return this.billing.filter(b => b.status === 'Pending').length;
                },
                get lowStockItems() {
                    return this.inventory.filter(i => i.quantity <= 10);
                },

                // --- Initialization ---
                async init() {
                    await this.fetchAllData();
                    this.loading = false;
                },

                // --- Data Fetching ---
                async fetchAllData() {
                    try {
                        const cacheBust = `?_=${new Date().getTime()}`;
                        const [patients, doctors, appointments, billing, inventory] = await Promise.all([
                            fetch(`/api/patients${cacheBust}`).then(res => res.json()),
                            fetch(`/api/doctors${cacheBust}`).then(res => res.json()),
                            fetch(`/api/appointments${cacheBust}`).then(res => res.json()),
                            fetch(`/api/billing${cacheBust}`).then(res => res.json()),
                            fetch(`/api/inventory${cacheBust}`).then(res => res.json())
                        ]);
                        this.patients = patients;
                        this.doctors = doctors;
                        this.appointments = appointments;
                        this.billing = billing;
                        this.inventory = inventory;
                    } catch (error) {
                        console.error("Error fetching data:", error);
                        this.showToast("Could not load data from the server.", "error");
                    }
                },

                async fetchData(type) {
                    try {
                        const cacheBust = `?_=${new Date().getTime()}`;
                        const response = await fetch(`/api/${type}${cacheBust}`);
                        const newData = await response.json();

                        this[type] = newData; // e.g., this.patients = newData

                    } catch (error) {
                        console.error(`Error fetching ${type}:`, error);
                    }
                },

                // --- Modal Management ---
                openModal(type, item = null) {
                    this.modal.type = type;
                    // Reset billing line item
                    this.billItem = { id: '', name: '', quantity: 1, price: 0 };

                    if (item) {
                        // Edit mode
                        this.modal.isEdit = true;
                        this.modal.title = `Edit ${type.slice(0, -1)}`;
                        this.form = JSON.parse(JSON.stringify(item)); // Deep clone

                        // Fix datetimes for inputs
                        if(type === 'appointments' && this.form.datetime) {
                            this.form.datetime = this.formatDateTimeForInput(this.form.datetime);
                        }
                    } else {
                        // Add mode
                        this.modal.isEdit = false;
                        this.modal.title = `Add ${type.slice(0, -1)}`;
                        this.form = { ...this.schemas[type] };

                        // Special handling for new bill
                        if (type === 'billing') {
                            this.form.items = [];
                        }
                    }
                    this.modal.open = true;
                },

                openViewItemsModal(bill) {
                    this.viewBillItems = bill.items || [];
                    this.modal.title = `Items for Bill #${bill.id.substring(0, 6)}...`;
                    this.modal.type = 'viewItems'; // Special modal type
                    this.modal.open = true;
                },

                // --- Form Submission ---
                async submitForm() {
                    const type = this.modal.type;
                    const url = this.modal.isEdit ? `/api/${type}/${this.form.id}` : `/api/${type}`;
                    const method = this.modal.isEdit ? 'PUT' : 'POST';

                    try {
                        const response = await fetch(url, {
                            method: method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.form)
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error || 'Server responded with an error');
                        }

                        await this.fetchData(type);
                        if (type === 'billing') await this.fetchData('inventory'); // Refresh inventory if we paid a bill

                        this.modal.open = false;
                        this.showToast(`${type.slice(0, -1)} saved successfully.`, 'success');

                    } catch (error) {
                        console.error("Error submitting form:", error);
                        this.showToast(error.message, 'error');
                    }
                },

                // --- Delete ---
                async deleteItem(type, id) {
                    if (!confirm(`Are you sure you want to delete this ${type.slice(0, -1)}?`)) return;

                    try {
                        const response = await fetch(`/api/${type}/${id}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) throw new Error('Server responded with an error');

                        await this.fetchData(type);
                        this.showToast(`${type.slice(0, -1)} deleted.`, 'success');
                    } catch (error) {
                        console.error("Error deleting item:", error);
                        this.showToast(`Could not delete item.`, 'error');
                    }
                },

                // --- Billing Actions (NEW for Feature #4) ---
                addBillItem() {
                    if (!this.billItem.id || this.billItem.quantity <= 0) {
                        this.showToast("Please select an item and quantity.", "error");
                        return;
                    }

                    // Find selected item from inventory to get details
                    const itemData = this.inventory.find(i => i.id === this.billItem.id);
                    if (!itemData) return;

                    // Check if item is already in the list
                    const existingItem = this.form.items.find(i => i.id === itemData.id);
                    if (existingItem) {
                        existingItem.quantity = parseInt(existingItem.quantity) + parseInt(this.billItem.quantity);
                    } else {
                        this.form.items.push({
                            id: itemData.id,
                            name: itemData.item,
                            quantity: parseInt(this.billItem.quantity),
                            price: parseFloat(itemData.price)
                        });
                    }
                    this.calculateBillTotal();

                    // Reset the item form
                    this.billItem = { id: '', name: '', quantity: 1, price: 0 };
                },

                removeBillItem(itemId) {
                    this.form.items = this.form.items.filter(i => i.id !== itemId);
                    this.calculateBillTotal();
                },

                calculateBillTotal() {
                    this.form.total = this.form.items.reduce((acc, item) => {
                        return acc + (item.price * item.quantity);
                    }, 0);
                },

                onBillItemSelect() {
                    const itemData = this.inventory.find(i => i.id === this.billItem.id);
                    if (itemData) {
                        this.billItem.name = itemData.item;
                        this.billItem.price = itemData.price;
                    }
                },

                async markBillAsPaid(billId) {
                    if (!confirm("Mark this bill as 'Paid'? This will deduct items from inventory.")) return;

                    try {
                        const response = await fetch(`/api/billing/pay/${billId}`, {
                            method: 'POST'
                        });
                        const result = await response.json();

                        if (!response.ok || !result.success) {
                            throw new Error(result.error || "Failed to process payment.");
                        }

                        this.showToast("Bill marked as Paid! Inventory updated.", 'success');
                        // Refresh both billing and inventory
                        await this.fetchData('billing');
                        await this.fetchData('inventory');

                    } catch (error) {
                        console.error("Error processing payment:", error);
                        this.showToast(error.message, 'error');
                    }
                },

                // --- Helper Functions ---
                calculateAge(dob) {
                    if (!dob) return 'N/A';
                    const diff = Date.now() - new Date(dob).getTime();
                    const ageDate = new Date(diff);
                    return Math.abs(ageDate.getUTCFullYear() - 1970);
                },

                formatDateTime(isoString) {
                    if (!isoString) return 'N/A';
                    try {
                        const date = new Date(isoString);
                        return date.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
                    } catch(e) { return isoString; }
                },

                formatDateTimeForInput(isoString) {
                    if (!isoString) return new Date().toISOString().slice(0, 16);
                    try {
                        const dt = new Date(isoString);
                        // Format to 'YYYY-MM-DDTHH:MM'
                        const year = dt.getFullYear();
                        const month = (dt.getMonth() + 1).toString().padStart(2, '0');
                        const day = dt.getDate().toString().padStart(2, '0');
                        const hours = dt.getHours().toString().padStart(2, '0');
                        const minutes = dt.getMinutes().toString().padStart(2, '0');
                        return `${year}-${month}-${day}T${hours}:${minutes}`;
                    } catch(e) {
                        return new Date().toISOString().slice(0, 16); // fallback
                    }
                },

                getPatientName(id) {
                    const patient = this.patients.find(p => p.id === id);
                    return patient ? patient.name : 'Unknown Patient';
                },

                getDoctorName(id) {
                    const doctor = this.doctors.find(d => d.id === id);
                    return doctor ? doctor.name : 'Unknown Doctor';
                },

                // --- Toast Notification ---
                toast: {
                    open: false,
                    message: '',
                    type: 'success' // 'success' or 'error'
                },

                showToast(message, type = 'success') {
                    this.toast.message = message;
                    this.toast.type = type;
                    this.toast.open = true;
                    setTimeout(() => this.toast.open = false, 3000);
                }
            }
        }
    </script>

    <style>
        /* Simple transitions for modal and toast */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.2s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }

        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-20px); }
        .toast-enter-to, .toast-leave-from { opacity: 1; transform: translateY(0); }

        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased" x-data="medicalApp()">

    <!-- Main Container -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg flex flex-col flex-shrink-0">
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-xl font-bold text-blue-700">Medical System</h1>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <template x-for="tab in tabs" :key="tab.id">
                    <button @click="currentTab = tab.id"
                            :class="currentTab === tab.id ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-100'"
                            class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg transition-all duration-200">
                        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" x-html="tab.icon"></svg>
                        <span class="truncate" x-text="tab.name"></span>
                    </button>
                </template>
            </nav>
        </div>

        <!-- Content Area -->
        <main class="flex-1 p-8 overflow-y-auto">
            <!-- Loading Spinner -->
            <div x-show="loading" class="flex justify-center items-center h-full">
                <div class="w-16 h-16 border-4 border-blue-500 border-dashed rounded-full animate-spin"></div>
            </div>

            <!-- Main Content (Tabs) -->
            <div x-show="!loading" x-cloak>

                <!-- Dashboard Tab -->
                <div x-show="currentTab === 'dashboard'">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Summary Cards -->
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-gray-700">Pending Bills</h3>
                            <p class="text-4xl font-bold text-blue-600" x-text="pendingBillCount"></p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-gray-700">Total Patients</h3>
                            <p class="text-4xl font-bold text-blue-600" x-text="patients.length"></p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-gray-700">Staff on Duty</h3>
                            <p class="text-4xl font-bold text-blue-600" x-text="doctors.length"></p>
                        </div>

                        <!-- Today's Appointments -->
                        <div class="bg-white p-6 rounded-lg shadow md:col-span-2">
                            <h3 class="text-lg font-medium text-gray-700 mb-4">Today's Appointments</h3>
                            <div class="space-y-3 max-h-60 overflow-y-auto">
                                <template x-if="todaysAppointments.length === 0">
                                    <p class="text-gray-500">No appointments scheduled for today.</p>
                                </template>
                                <template x-for="appt in todaysAppointments" :key="appt.id">
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                        <div>
                                            <p class="font-medium text-gray-800" x-text="getPatientName(appt.patient)"></p>
                                            <p class="text-sm text-gray-500">with <span x-text="getDoctorName(appt.doctor)"></span></p>
                                        </div>
                                        <div class="text-sm text-gray-700" x-text="formatDateTime(appt.datetime).split(', ')[1]"></div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Low Stock Items -->
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-gray-700 mb-4">Low Stock</h3>
                            <div class="space-y-3 max-h-60 overflow-y-auto">
                                <template x-if="lowStockItems.length === 0">
                                    <p class="text-gray-500">Inventory is well-stocked.</p>
                                </template>
                                <template x-for="item in lowStockItems" :key="item.id">
                                    <div class="flex justify-between items-center p-3 bg-red-50 rounded">
                                        <p class="font-medium text-red-800" x-text="item.item"></p>
                                        <p class="text-sm text-red-600 font-bold" x-text="`Only ${item.quantity} left`"></p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patients Tab -->
                <div x-show="currentTab === 'patients'">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Patient Management</h2>
                    <div class="flex justify-between mb-4">
                        <input type="text" x-model="searchPatient" placeholder="Search by name..." class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button @click="openModal('patients')" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all">Add Patient</button>
                    </div>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">History</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <template x-for="patient in filteredPatients" :key="patient.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="patient.name"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="calculateAge(patient.dob)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="patient.gender"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="patient.contact"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500 truncate max-w-sm" x-text="patient.history"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <button @click="openModal('patients', patient)" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                                            <button @click="deleteItem('patients', patient.id)" class="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Doctors Tab -->
                <div x-show="currentTab === 'doctors'">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Doctor Management</h2>
                    <div class="flex justify-between mb-4">
                        <input type="text" x-model="searchDoctor" placeholder="Search by name or specialty..." class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button @click="openModal('doctors')" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all">Add Doctor</button>
                    </div>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Specialty</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Schedule</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <template x-for="doctor in filteredDoctors" :key="doctor.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="doctor.name"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="doctor.specialty"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="doctor.schedule"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <button @click="openModal('doctors', doctor)" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                                            <button @click="deleteItem('doctors', doctor.id)" class="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Appointments Tab -->
                <div x-show="currentTab === 'appointments'">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Appointment Management</h2>
                    <div class="flex justify-between mb-4">
                        <input type="text" x-model="searchAppointment" placeholder="Search by patient or doctor..." class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button @click="openModal('appointments')" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all">Schedule Appointment</button>
                    </div>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Doctor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date/Time</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <template x-for="appt in filteredAppointments" :key="appt.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="getPatientName(appt.patient)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="getDoctorName(appt.doctor)"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDateTime(appt.datetime)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <button @click="openModal('appointments', appt)" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                                            <button @click="deleteItem('appointments', appt.id)" class="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Billing Tab -->
                <div x-show="currentTab === 'billing'">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Billing Management</h2>
                    <div class="flex justify-between mb-4">
                        <input type="text" x-model="searchBilling" placeholder="Search by patient or status..." class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button @click="openModal('billing')" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all">Add Bill</button>
                    </div>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <template x-for="bill in filteredBilling" :key="bill.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="getPatientName(bill.patient)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="`$${bill.total.toFixed(2)}`"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                  :class="{ 'bg-green-100 text-green-800': bill.status === 'Paid', 'bg-yellow-100 text-yellow-800': bill.status === 'Pending', 'bg-red-100 text-red-800': bill.status === 'Overdue' }"
                                                  x-text="bill.status"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <button @click="openViewItemsModal(bill)" class="text-gray-600 hover:text-gray-900">View</button>
                                            <button @click="openModal('billing', bill)" class="text-indigo-600 hover:text-indigo-900" x-show="bill.status !== 'Paid'">Edit</button>
                                            <button @click="markBillAsPaid(bill.id)" class="text-green-600 hover:text-green-900" x-show="bill.status === 'Pending'">Mark as Paid</button>
                                            <button @click="deleteItem('billing', bill.id)" class="text-red-600 hover:text-red-900" x-show="bill.status !== 'Paid'">Delete</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Inventory Tab -->
                <div x-show="currentTab === 'inventory'">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Inventory Management</h2>
                    <div class="flex justify-between mb-4">
                        <input type="text" x-model="searchInventory" placeholder="Search by item name..." class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button @click="openModal('inventory')" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all">Add Item</button>
                    </div>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price (per unit)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <template x-for="item in filteredInventory" :key="item.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="item.item"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.quantity"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="`$${item.price.toFixed(2)}`"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="item.supplier"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <button @click="openModal('inventory', item)" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                                            <button @click="deleteItem('inventory', item.id)" class="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Universal Modal -->
    <div x-show="modal.open"
         class="fixed inset-0 z-50 overflow-y-auto"
         x-transition:enter="modal-enter-active"
         x-transition:leave="modal-leave-active"
         x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div x-show="modal.open"
                 x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                 class="fixed inset-0 transition-opacity"
                 @click="modal.open = false">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <!-- Modal panel -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen"></span>&#8203;
            <div x-show="modal.open"
                 x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">

                <form @submit.prevent="modal.type === 'viewItems' ? modal.open = false : submitForm()">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" x-text="modal.title"></h3>
                        <div class="mt-4 space-y-4 max-h-[60vh] overflow-y-auto pr-2">

                            <!-- Patient Fields -->
                            <template x-if="modal.type === 'patients'">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Name</label>
                                        <input type="text" x-model="form.name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
                                        <input type="date" x-model="form.dob" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Gender</label>
                                        <select x-model="form.gender" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                            <option value="M">Male</option>
                                            <option value="F">Female</option>
                                            <option value="O">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Contact</label>
                                        <input type="text" x-model="form.contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Medical History</label>
                                        <textarea x-model="form.history" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                                    </div>
                                </div>
                            </template>

                            <!-- Doctor Fields -->
                            <template x-if="modal.type === 'doctors'">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Name</label>
                                        <input type="text" x-model="form.name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Specialty</label>
                                        <input type="text" x-model="form.specialty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Schedule</label>
                                        <input type="text" x-model="form.schedule" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                </div>
                            </template>

                            <!-- Appointment Fields -->
                            <template x-if="modal.type === 'appointments'">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Patient</label>
                                        <select x-model="form.patient" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                            <option value="" disabled>Select a patient</option>
                                            <template x-for="p in patients" :key="p.id">
                                                <option :value="p.id" x-text="p.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Doctor</label>
                                        <select x-model="form.doctor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                            <option value="" disabled>Select a doctor</option>
                                            <template x-for="d in doctors" :key="d.id">
                                                <option :value="d.id" x-text="`${d.name} (${d.specialty})`"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Date & Time</label>
                                        <input type="datetime-local" x-model="form.datetime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                </div>
                            </template>

                            <!-- Billing Fields (NEW) -->
                            <template x-if="modal.type === 'billing'">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Patient</label>
                                        <select x-model="form.patient" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required :disabled="form.status === 'Paid'">
                                            <option value="" disabled>Select a patient</option>
                                            <template x-for="p in patients" :key="p.id">
                                                <option :value="p.id" x-text="p.name"></option>
                                            </template>
                                        </select>
                                    </div>

                                    <!-- Add Bill Items -->
                                    <div x-show="form.status !== 'Paid'">
                                        <label class="block text-sm font-medium text-gray-700">Add Items</label>
                                        <div class="mt-1 flex space-x-2">
                                            <select x-model="billItem.id" @change="onBillItemSelect()" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                                <option value="" disabled>Select an item...</option>
                                                <template x-for="i in inventory" :key="i.id">
                                                    <option :value="i.id" x-text="`${i.item} ($${i.price.toFixed(2)}) - Stock: ${i.quantity}`"></option>
                                                </template>
                                            </select>
                                            <input type="number" min="1" x-model.number="billItem.quantity" class="block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                            <button type="button" @click="addBillItem()" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">Add</button>
                                        </div>
                                    </div>

                                    <!-- Added Items List -->
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-gray-700">Bill Items</label>
                                        <template x-if="form.items.length === 0">
                                            <p class="text-sm text-gray-500">No items added to this bill.</p>
                                        </template>
                                        <template x-for="item in form.items" :key="item.id">
                                            <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                                                <div>
                                                    <p class="font-medium text-sm" x-text="`${item.name} (x${item.quantity})`"></p>
                                                    <p class="text-xs text-gray-500" x-text="`$${item.price.toFixed(2)} each = $${(item.price * item.quantity).toFixed(2)}`"></p>
                                                </div>
                                                <button type="button" @click="removeBillItem(item.id)" class="text-red-500 hover:text-red-700" x-show="form.status !== 'Paid'">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                                </button>
                                            </div>
                                        </template>
                                    </div>

                                    <!-- Bill Total -->
                                    <div class="text-right">
                                        <label class="text-sm font-medium text-gray-700">Total:</label>
                                        <span class="text-xl font-bold text-gray-900" x-text="`$${form.total.toFixed(2)}`"></span>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Status</label>
                                        <select x-model="form.status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" :disabled="form.status === 'Paid'">
                                            <option>Pending</option>
                                            <option>Paid</option>
                                            <option>Overdue</option>
                                        </select>
                                    </div>
                                </div>
                            </template>

                            <!-- Inventory Fields -->
                            <template x-if="modal.type === 'inventory'">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Item Name</label>
                                        <input type="text" x-model="form.item" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Quantity</label>
                                        <input type="number" min="0" x-model.number="form.quantity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Price (per unit)</label>
                                        <input type="number" min="0" step="0.01" x-model.number="form.price" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Supplier</label>
                                        <input type="text" x-model="form.supplier" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                </div>
                            </template>

                            <!-- View Bill Items (Read-only) -->
                            <template x-if="modal.type === 'viewItems'">
                                <div class="space-y-2">
                                    <template x-if="viewBillItems.length === 0">
                                        <p class="text-sm text-gray-500">This bill has no items.</p>
                                    </template>
                                    <template x-for="item in viewBillItems" :key="item.id">
                                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                                            <div>
                                                <p class="font-medium text-sm" x-text="`${item.name} (x${item.quantity})`"></p>
                                                <p class="text-xs text-gray-500" x-text="`$${item.price.toFixed(2)} each = $${(item.price * item.quantity).toFixed(2)}`"></p>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <template x-if="modal.type !== 'viewItems'">
                            <button type="submit"
                                    :disabled="form.status === 'Paid'"
                                    :class="{ 'opacity-50 cursor-not-allowed': form.status === 'Paid' }"
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm"
                                    x-text="modal.isEdit ? 'Update' : 'Save'"></button>
                        </template>
                        <button type="button"
                                @click="modal.open = false"
                                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                                x-text="modal.type === 'viewItems' ? 'Close' : 'Cancel'">
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="toast.open"
         x-transition:enter="toast-enter-active"
         x-transition:leave="toast-leave-active"
         class="fixed top-5 right-5 z-50"
         x-cloak>
        <div class="px-4 py-3 rounded-md shadow-lg"
             :class="toast.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'">
            <span x-text="toast.message"></span>
        </div>
    </div>

</body>
</html>

