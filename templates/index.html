<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Management System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        function medicalApp() {
            return {
                loading: true,
                currentTab: 'dashboard', // Default tab
                tabs: [
                    { id: 'dashboard', name: 'Dashboard', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1V9a1 1 0 011-1h2a1 1 0 011 1v10a1 1 0 001 1m-6 0h6"></path>' },
                    { id: 'patients', name: 'Patients', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>' },
                    { id: 'doctors', name: 'Doctors', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9a3 3 0 00-3-3h-1.5a3 3 0 100 6H15a3 3 0 003-3zM9 9a3 3 0 00-3-3H4.5a3 3 0 100 6H6a3 3 0 003-3zM12 15a3 3 0 00-3-3H7.5a3 3 0 100 6H9a3 3 0 003-3z"></path>' },
                    { id: 'appointments', name: 'Appointments', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>' },
                    { id: 'billing', name: 'Billing', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>' },
                    { id: 'inventory', name: 'Inventory', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>' }
                ],

                // --- Search Text Properties ---
                searchPatient: '',
                searchDoctor: '',
                searchAppointment: '',
                searchBilling: '',
                searchInventory: '',

                // --- Data Properties ---
                patients: [],
                doctors: [],
                appointments: [],
                billing: [],
                inventory: [],

                // --- MODIFIED: Added list of doctor specialties ---
                doctorSpecialties: [
                    'General Physician', 'Pediatrician', 'Gynecologist', 'Orthopedic Surgeon',
                    'Cardiologist', 'Dermatologist', 'ENT Specialist', 'Ophthalmologist',
                    'Neurologist', 'Psychiatrist', 'Dentist', 'Radiologist', 'Oncologist',
                    'Urologist', 'Nephrologist', 'Gastroenterologist', 'Endocrinologist',
                    'Pulmonologist', 'Physiotherapist', 'Emergency Medicine'
                ],

                modal: {
                    open: false,
                    type: '',
                    title: '',
                    isEdit: false
                },
                form: {},

                // For "View Items" modal
                billModal: {
                    open: false,
                    patientName: '',
                    items: [],
                    total: 0
                },

                // For adding items to a bill in the modal
                billForm: {
                    itemId: '',
                    quantity: 1
                },

                // Schemas for clearing the form
                schemas: {
                    // MODIFIED: dob is now a date string, gender has a default
                    patients: { id: null, name: '', contact: '', history: '', dob: '', gender: 'M' },
                    // MODIFIED: default specialty
                    doctors: { id: null, name: '', specialty: 'General Physician', schedule: '' },
                    // MODIFIED: default patient/doctor ID to null
                    appointments: { id: null, patient: null, doctor: null, datetime: new Date().toISOString().slice(0, 16) },
                    // MODIFIED: patient is an ID, items is an array
                    billing: { id: null, patient: null, items: [], total: 0, status: 'Pending' },
                    // MODIFIED: Added price
                    inventory: { id: null, item: '', quantity: 0, supplier: '', price: 0.0 }
                },

                // --- Computed Properties for Filtering ---
                get filteredPatients() {
                    if (!this.searchPatient) return this.patients;
                    const search = this.searchPatient.toLowerCase();
                    return this.patients.filter(p =>
                        p.name.toLowerCase().includes(search) ||
                        p.contact.toLowerCase().includes(search)
                    );
                },
                get filteredDoctors() {
                    if (!this.searchDoctor) return this.doctors;
                    const search = this.searchDoctor.toLowerCase();
                    return this.doctors.filter(d =>
                        d.name.toLowerCase().includes(search) ||
                        d.specialty.toLowerCase().includes(search)
                    );
                },
                get filteredAppointments() {
                    if (!this.searchAppointment) return this.appointments;
                    const search = this.searchAppointment.toLowerCase();
                    return this.appointments.filter(a =>
                        this.getPatientName(a.patient).toLowerCase().includes(search) ||
                        this.getDoctorName(a.doctor).toLowerCase().includes(search)
                    );
                },
                get filteredBilling() {
                    if (!this.searchBilling) return this.billing;
                    const search = this.searchBilling.toLowerCase();
                    return this.billing.filter(b =>
                        this.getPatientName(b.patient).toLowerCase().includes(search) ||
                        b.status.toLowerCase().includes(search)
                    );
                },
                get filteredInventory() {
                    if (!this.searchInventory) return this.inventory;
                    const search = this.searchInventory.toLowerCase();
                    return this.inventory.filter(i =>
                        i.item.toLowerCase().includes(search) ||
                        i.supplier.toLowerCase().includes(search)
                    );
                },

                // --- Computed Properties for Dashboard ---
                get pendingBillCount() {
                    return this.billing.filter(b => b.status === 'Pending').length;
                },
                get lowStockItems() {
                    return this.inventory.filter(i => i.quantity <= 10); // Show items with 10 or less in stock
                },
                get todaysAppointments() {
                    const today = new Date().setHours(0, 0, 0, 0);
                    return this.appointments.filter(appt => {
                        const apptDate = new Date(appt.datetime).setHours(0, 0, 0, 0);
                        return apptDate === today;
                    }).sort((a,b) => new Date(a.datetime) - new Date(b.datetime)); // Sort by time
                },

                // Load all data from our Flask API
                async init() {
                    await this.fetchAllData();
                    this.loading = false;
                },

                async fetchAllData() {
                    try {
                        const cacheBust = `?_=${new Date().getTime()}`;
                        const [patients, doctors, appointments, billing, inventory] = await Promise.all([
                            fetch(`/api/patients${cacheBust}`).then(res => res.json()),
                            fetch(`/api/doctors${cacheBust}`).then(res => res.json()),
                            fetch(`/api/appointments${cacheBust}`).then(res => res.json()),
                            fetch(`/api/billing${cacheBust}`).then(res => res.json()),
                            fetch(`/api/inventory${cacheBust}`).then(res => res.json())
                        ]);
                        this.patients = patients;
                        this.doctors = doctors;
                        this.appointments = appointments;
                        this.billing = billing;
                        this.inventory = inventory;
                    } catch (error) {
                        console.error("Error fetching data:", error);
                        alert("Could not load data from the server.");
                    }
                },

                // Fetch data for a specific type
                async fetchData(type) {
                    try {
                        const cacheBust = `?_=${new Date().getTime()}`;
                        const response = await fetch(`/api/${type}${cacheBust}`);
                        const newData = await response.json();

                        this[type] = newData; // e.g., this.patients = newData

                    } catch (error) {
                        console.error(`Error fetching ${type}:`, error);
                    }
                },

                // --- Modal Functions ---

                openModal(type, item = null) {
                    this.modal.type = type;
                    // Reset bill line item form
                    this.billForm = { itemId: '', quantity: 1 };

                    if (item) {
                        // Edit mode
                        this.modal.isEdit = true;
                        this.modal.title = `Edit ${type.slice(0, -1)}`;
                        // Clone item data to form
                        this.form = { ...item };

                        // Special handling for appointment datetime
                        if(type === 'appointments' && this.form.datetime) {
                            this.form.datetime = this.formatISODate(this.form.datetime);
                        }
                    } else {
                        // Add mode
                        this.modal.isEdit = false;
                        this.modal.title = `Add ${type.slice(0, -1)}`;
                        // Use schema to reset form
                        this.form = { ...this.schemas[type] };
                        // Ensure 'items' array is fresh for new bill
                        if (type === 'billing') {
                            this.form.items = [];
                        }
                    }
                    this.modal.open = true;
                },

                openBillViewModal(bill) {
                    this.billModal.patientName = this.getPatientName(bill.patient);
                    this.billModal.items = bill.items || [];
                    this.billModal.total = bill.total || 0;
                    this.billModal.open = true;
                },

                // Handle form submission (Add or Edit)
                async submitForm() {
                    const type = this.modal.type;

                    // Recalculate total for billing just before submit
                    if (type === 'billing') {
                        this.calculateBillTotal();
                    }

                    const url = this.modal.isEdit ? `/api/${type}/${this.form.id}` : `/api/${type}`;
                    const method = this.modal.isEdit ? 'PUT' : 'POST';

                    try {
                        const response = await fetch(url, {
                            method: method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.form)
                        });

                        if (!response.ok) throw new Error('Server responded with an error');

                        // Refresh data for the current tab and close modal
                        await this.fetchData(type);
                        this.modal.open = false;

                    } catch (error) {
                        console.error("Error submitting form:", error);
                        alert(`Could not save ${this.modal.type}. Please try again.`);
                    }
                },

                // Delete an item
                async deleteItem(type, id) {
                    if (!confirm(`Are you sure you want to delete this ${type.slice(0, -1)}?`)) return;

                    try {
                        const response = await fetch(`/api/${type}/${id}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) throw new Error('Server responded with an error');

                        await this.fetchData(type);
                    } catch (error) {
                        console.error("Error deleting item:", error);
                        alert(`Could not delete ${this.modal.type}. Please try again.`);
                    }
                },

                // --- Billing-Specific Functions (Feature #4) ---

                addItemToBill() {
                    if (!this.billForm.itemId || this.billForm.quantity <= 0) {
                        alert("Please select an item and enter a valid quantity.");
                        return;
                    }

                    const itemToAdd = this.inventory.find(i => i.id === this.billForm.itemId);
                    if (!itemToAdd) {
                        alert("Item not found in inventory.");
                        return;
                    }

                    // Check if item is already on bill
                    const existingItem = this.form.items.find(i => i.id === itemToAdd.id);
                    if (existingItem) {
                        existingItem.quantity = parseInt(existingItem.quantity) + parseInt(this.billForm.quantity);
                    } else {
                        this.form.items.push({
                            id: itemToAdd.id,
                            name: itemToAdd.item,
                            price: itemToAdd.price,
                            quantity: parseInt(this.billForm.quantity)
                        });
                    }

                    this.calculateBillTotal();
                    // Reset bill item form
                    this.billForm = { itemId: '', quantity: 1 };
                },

                removeItemFromBill(itemId) {
                    this.form.items = this.form.items.filter(i => i.id !== itemId);
                    this.calculateBillTotal();
                },

                calculateBillTotal() {
                    let total = 0;
                    this.form.items.forEach(item => {
                        total += (item.price * item.quantity);
                    });
                    this.form.total = total;
                },

                async markBillAsPaid(billId) {
                    if (!confirm("This will mark the bill as 'Paid' and update inventory stock. This action cannot be undone. Proceed?")) return;

                    try {
                        const response = await fetch(`/api/billing/pay/${billId}`, {
                            method: 'POST'
                        });
                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.error || 'Failed to process payment.');
                        }

                        alert("Bill marked as paid and inventory updated!");
                        // Refresh both billing and inventory data
                        await this.fetchData('billing');
                        await this.fetchData('inventory');

                    } catch (error) {
                        console.error("Error processing payment:", error);
                        alert(`Payment processing failed: ${error.message}`);
                    }
                },

                // --- Helper/Utility Functions ---

                // Calculates age from DOB string (YYYY-MM-DD)
                calculateAge(dob) {
                    if (!dob) return 'N/A';
                    try {
                        const birthDate = new Date(dob);
                        const today = new Date();
                        let age = today.getFullYear() - birthDate.getFullYear();
                        const m = today.getMonth() - birthDate.getMonth();
                        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                            age--;
                        }
                        return age;
                    } catch(e) {
                        return 'N/A';
                    }
                },

                // Formats ISO string for 'datetime-local' input
                formatISODate(isoString) {
                    if (!isoString) return new Date().toISOString().slice(0, 16);
                    try {
                        const dt = new Date(isoString);
                        // Format to 'YYYY-MM-DDTHH:MM'
                        const year = dt.getFullYear();
                        const month = (dt.getMonth() + 1).toString().padStart(2, '0');
                        const day = dt.getDate().toString().padStart(2, '0');
                        const hours = dt.getHours().toString().padStart(2, '0');
                        const minutes = dt.getMinutes().toString().padStart(2, '0');
                        return `${year}-${month}-${day}T${hours}:${minutes}`;
                    } catch(e) {
                        return new Date().toISOString().slice(0, 16); // fallback
                    }
                },

                // Formats ISO string for display
                formatDisplayDateTime(isoString) {
                    if (!isoString) return 'N/A';
                    try {
                        const date = new Date(isoString);
                        return date.toLocaleString('en-US', {
                            dateStyle: 'medium',
                            timeStyle: 'short'
                        });
                    } catch(e) {
                        return isoString; // fallback
                    }
                },

                // Find Patient/Doctor name from ID
                getPatientName(id) {
                    if (!id) return 'Unknown Patient';
                    const patient = this.patients.find(p => p.id === id);
                    return patient ? patient.name : `Patient ID (${id.slice(0,5)}...)`;
                },
                getDoctorName(id) {
                    if (!id) return 'Unknown Doctor';
                    const doctor = this.doctors.find(d => d.id === id);
                    return doctor ? doctor.name : `Doctor ID (${id.slice(0,5)}...)`;
                }
            }
        }
    </script>

    <!-- Use defer to make sure Alpine.js runs *after* the medicalApp function is defined -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        /* Simple transition for modal */
        .modal-enter-active, .modal-leave-active {
            transition: opacity 0.2s ease;
        }
        .modal-enter-from, .modal-leave-to {
            opacity: 0;
        }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased" x-data="medicalApp()">

    <!-- Main Container -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg flex flex-col">
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-xl font-bold text-blue-700">Medical System</h1>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <template x-for="tab in tabs" :key="tab.id">
                    <button @click="currentTab = tab.id"
                            :class="currentTab === tab.id ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-100'"
                            class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg transition-all duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" x-html="tab.icon"></svg>
                        <span x-text="tab.name"></span>
                    </button>
                </template>
            </nav>
        </div>

        <!-- Content Area -->
        <main class="flex-1 p-8 overflow-y-auto">
            <!-- Loading Spinner -->
            <div x-show="loading" class="flex justify-center items-center h-full">
                <div class="w-16 h-16 border-4 border-blue-500 border-dashed rounded-full animate-spin"></div>
            </div>

            <!-- Main Content (Tabs) -->
            <div x-show="!loading" x-cloak>

                <!-- Dashboard Tab -->
                <div x-show="currentTab === 'dashboard'">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                        <!-- Today's Appointments -->
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Today's Appointments</h3>
                            <div class="space-y-4 max-h-60 overflow-y-auto">
                                <template x-if="todaysAppointments.length === 0">
                                    <p class="text-sm text-gray-500">No appointments scheduled for today.</p>
                                </template>
                                <template x-for="appt in todaysAppointments" :key="appt.id">
                                    <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                                        <p class="font-semibold text-blue-800" x-text="getPatientName(appt.patient)"></p>
                                        <p class="text-sm text-blue-600" x-text="getDoctorName(appt.doctor)"></p>
                                        <p class="text-sm text-gray-700" x-text="formatDisplayDateTime(appt.datetime)"></p>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Pending Bills -->
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Pending Bills</h3>
                            <div class="flex items-center justify-center">
                                <p class="text-6xl font-bold text-yellow-500" x-text="pendingBillCount"></p>
                            </div>
                        </div>

                        <!-- Low Stock Items -->
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Low Stock Items (<= 10)</h3>
                            <div class="space-y-3 max-h-60 overflow-y-auto">
                                <template x-if="lowStockItems.length === 0">
                                    <p class="text-sm text-gray-500">Inventory is well-stocked.</p>
                                </template>
                                <template x-for="item in lowStockItems" :key="item.id">
                                    <div class="flex justify-between items-center p-2 bg-red-50 rounded border border-red-200">
                                        <span class="text-sm font-medium text-red-800" x-text="item.item"></span>
                                        <span class="text-sm font-bold text-red-600" x-text="item.quantity"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Patients Tab -->
                <div x-show="currentTab === 'patients'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Patient Management</h2>
                        <input type="text" x-model="searchPatient" placeholder="Search patients..." class="w-1/3 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button @click="openModal('patients')" class="mb-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all">Add Patient</button>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">History</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <!-- MODIFIED: Loop over filteredPatients -->
                                <template x-for="patient in filteredPatients" :key="patient.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="patient.name"></td>
                                        <!-- MODIFIED: Calculate age from DOB -->
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="calculateAge(patient.dob)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="patient.gender"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="patient.contact"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500 truncate max-w-sm" x-text="patient.history"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <button @click="openModal('patients', patient)" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                                            <button @click="deleteItem('patients', patient.id)" class="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Doctors Tab -->
                <div x-show="currentTab === 'doctors'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Doctor Management</h2>
                        <input type="text" x-model="searchDoctor" placeholder="Search doctors..." class="w-1/3 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button @click="openModal('doctors')" class="mb-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all">Add Doctor</button>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Specialty</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Schedule</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <!-- MODIFIED: Loop over filteredDoctors -->
                                <template x-for="doctor in filteredDoctors" :key="doctor.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="doctor.name"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="doctor.specialty"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="doctor.schedule"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <button @click="openModal('doctors', doctor)" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                                            <button @click="deleteItem('doctors', doctor.id)" class="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Appointments Tab -->
                <div x-show="currentTab === 'appointments'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Appointment Management</h2>
                        <input type="text" x-model="searchAppointment" placeholder="Search by patient or doctor..." class="w-1/3 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button @click="openModal('appointments')" class="mb-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all">Schedule Appointment</button>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Doctor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date/Time</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <!-- MODIFIED: Loop over filteredAppointments -->
                                <template x-for="appt in filteredAppointments" :key="appt.id">
                                    <tr>
                                        <!-- MODIFIED: Use helper to get name from ID -->
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="getPatientName(appt.patient)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="getDoctorName(appt.doctor)"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDisplayDateTime(appt.datetime)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <button @click="openModal('appointments', appt)" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                                            <button @click="deleteItem('appointments', appt.id)" class="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Billing Tab -->
                <div x-show="currentTab === 'billing'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Billing Management</h2>
                        <input type="text" x-model="searchBilling" placeholder="Search by patient or status..." class="w-1/3 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button @click="openModal('billing')" class="mb-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all">Add Bill</button>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <!-- MODIFIED: Loop over filteredBilling -->
                                <template x-for="bill in filteredBilling" :key="bill.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="getPatientName(bill.patient)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="bill.total ? `$${bill.total.toFixed(2)}` : '$0.00'"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                  :class="{ 'bg-green-100 text-green-800': bill.status === 'Paid', 'bg-yellow-100 text-yellow-800': bill.status === 'Pending', 'bg-red-100 text-red-800': bill.status === 'Overdue' }"
                                                  x-text="bill.status"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <!-- MODIFIED: Added 'View Items' and 'Mark as Paid' buttons -->
                                            <button @click="openBillViewModal(bill)" class="text-blue-600 hover:text-blue-900">View Items</button>
                                            <button x-show="bill.status !== 'Paid'" @click="markBillAsPaid(bill.id)" class="text-green-600 hover:text-green-900">Mark as Paid</button>
                                            <button @click="openModal('billing', bill)" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                                            <button @click="deleteItem('billing', bill.id)" class="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Inventory Tab -->
                <div x-show="currentTab === 'inventory'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Inventory Management</h2>
                        <input type="text" x-model="searchInventory" placeholder="Search inventory..." class="w-1/3 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button @click="openModal('inventory')" class="mb-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all">Add Item</button>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <!-- MODIFIED: Loop over filteredInventory -->
                                <template x-for="item in filteredInventory" :key="item.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="item.item"></td>
                                        <!-- MODIFIED: Added Price column -->
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.price ? `$${item.price.toFixed(2)}` : '$0.00'"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.quantity"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="item.supplier"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                            <button @click="openModal('inventory', item)" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                                            <button @click="deleteItem('inventory', item.id)" class="text-red-600 hover:text-red-900">Delete</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Main Add/Edit Modal -->
    <div x-show="modal.open"
         class="fixed inset-0 z-10 overflow-y-auto"
         x-transition:enter="modal-enter-active"
         x-transition:leave="modal-leave-active"
         x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div x-show="modal.open"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="fixed inset-0 transition-opacity"
                 @click="modal.open = false">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <!-- Modal panel -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen"></span>&#8203;
            <div x-show="modal.open"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">

                <form @submit.prevent="submitForm()">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" x-text="modal.title"></h3>
                        <div class="mt-4 space-y-4">
                            <!-- Patient Fields -->
                            <template x-if="modal.type === 'patients'">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Name</label>
                                        <input type="text" x-model="form.name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                    <!-- MODIFIED: Changed Age to DOB (Date of Birth) -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
                                        <input type="date" x-model="form.dob" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                    <!-- MODIFIED: Added Gender dropdown -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Gender</label>
                                        <select x-model="form.gender" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                            <option value="M">Male</option>
                                            <option value="F">Female</option>
                                            <option value="O">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Contact</label>
                                        <input type="text" x-model="form.contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Medical History</label>
                                        <textarea x-model="form.history" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                                    </div>
                                </div>
                            </template>

                            <!-- Doctor Fields -->
                            <template x-if="modal.type === 'doctors'">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Name</label>
                                        <input type="text" x-model="form.name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                    <!-- MODIFIED: Changed Specialty to a dropdown -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Specialty</label>
                                        <select x-model="form.specialty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                            <template x-for="spec in doctorSpecialties" :key="spec">
                                                <option :value="spec" x-text="spec"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Schedule</label>
                                        <input type="text" x-model="form.schedule" placeholder="e.g., Mon-Fri 9am-5pm" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                </div>
                            </template>

                            <!-- Appointment Fields -->
                            <template x-if="modal.type === 'appointments'">
                                <div class="space-y-4">
                                    <!-- MODIFIED: Dropdown for Patient -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Patient</label>
                                        <select x-model="form.patient" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                            <option value="" disabled>Select a patient</option>
                                            <template x-for="p in patients" :key="p.id">
                                                <option :value="p.id" x-text="p.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <!-- MODIFIED: Dropdown for Doctor -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Doctor</label>
                                        <select x-model="form.doctor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                            <option value="" disabled>Select a doctor</option>
                                            <template x-for="d in doctors" :key="d.id">
                                                <option :value="d.id" x-text="`${d.name} (${d.specialty})`"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Date & Time</label>
                                        <input type="datetime-local" x-model="form.datetime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                </div>
                            </template>

                            <!-- Billing Fields (Overhauled for Feature #4) -->
                            <template x-if="modal.type === 'billing'">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Patient</label>
                                        <select x-model="form.patient" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                            <option value="" disabled>Select a patient</option>
                                            <template x-for="p in patients" :key="p.id">
                                                <option :value="p.id" x-text="p.name"></option>
                                            </template>
                                        </select>
                                    </div>

                                    <!-- Add Bill Items -->
                                    <div class="border-t border-gray-200 pt-4">
                                        <label class="block text-sm font-medium text-gray-700">Add Items to Bill</label>
                                        <div class="flex space-x-2 mt-1">
                                            <select x-model="billForm.itemId" class="block w-2/3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                                <option value="" disabled>Select an item...</option>
                                                <template x-for="i in inventory" :key="i.id">
                                                    <option :value="i.id" x-text="`${i.item} - $${i.price.toFixed(2)} (Stock: ${i.quantity})`"></option>
                                                </template>
                                            </select>
                                            <input type="number" x-model.number="billForm.quantity" min="1" class="block w-1/4 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                            <button type="button" @click="addItemToBill" class="w-auto px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Add</button>
                                        </div>
                                    </div>

                                    <!-- Bill Items List -->
                                    <div class="space-y-2 max-h-40 overflow-y-auto" x-show="form.items.length > 0">
                                        <template x-for="item in form.items" :key="item.id">
                                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                                <div>
                                                    <p class="text-sm font-medium text-gray-900" x-text="item.name"></p>
                                                    <p class="text-sm text-gray-500" x-text="`${item.quantity} x $${item.price.toFixed(2)} = $${(item.quantity * item.price).toFixed(2)}`"></p>
                                                </div>
                                                <button type="button" @click="removeItemFromBill(item.id)" class="text-red-500 hover:text-red-700">&times;</button>
                                            </div>
                                        </template>
                                    </div>

                                    <!-- Bill Total and Status -->
                                    <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                                        <h4 class="text-lg font-bold">Total: $<span x-text="form.total.toFixed(2)"></span></h4>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Status</label>
                                            <select x-model="form.status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                                <option>Pending</option>
                                                <option>Paid</option>
                                                <option>Overdue</option>
                                            </select>
                                        </div>
                                    </div>

                                </div>
                            </template>

                            <!-- Inventory Fields -->
                            <template x-if="modal.type === 'inventory'">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Item Name</label>
                                        <input type="text" x-model="form.item" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                    <!-- MODIFIED: Added Price -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Price ($)</label>
                                        <input type="number" step="0.01" x-model.number="form.price" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Quantity</label>
                                        <input type="number" x-model.number="form.quantity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Supplier</label>
                                        <input type="text" x-model="form.supplier" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                </div>
                            </template>

                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm"
                                x-text="modal.isEdit ? 'Update' : 'Save'"></button>
                        <button type="button"
                                @click="modal.open = false"
                                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Bill Items Modal (Feature #4) -->
    <div x-show="billModal.open"
         class="fixed inset-0 z-20 overflow-y-auto"
         x-transition:enter="modal-enter-active"
         x-transition:leave="modal-leave-active"
         x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div x-show="billModal.open"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="fixed inset-0 transition-opacity"
                 @click="billModal.open = false">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>

            <!-- Modal panel -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen"></span>&#8203;
            <div x-show="billModal.open"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full">

                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Bill Details</h3>
                    <p class="text-sm text-gray-500 mb-4">Patient: <span class="font-medium" x-text="billModal.patientName"></span></p>

                    <div class="space-y-2 max-h-60 overflow-y-auto border-t border-b border-gray-200 py-4">
                        <template x-if="billModal.items.length === 0">
                            <p class="text-sm text-gray-500">No items on this bill.</p>
                        </template>
                        <template x-for="item in billModal.items" :key="item.id">
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <div>
                                    <p class="text-sm font-medium text-gray-900" x-text="item.name"></p>
                                    <p class="text-sm text-gray-500" x-text="`${item.quantity} x $${item.price.toFixed(2)} = $${(item.quantity * item.price).toFixed(2)}`"></p>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="flex justify-end items-center pt-4">
                        <h4 class="text-lg font-bold">Total: $<span x-text="billModal.total.toFixed(2)"></span></h4>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button"
                            @click="billModal.open = false"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>

